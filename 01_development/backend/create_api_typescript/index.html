<!DOCTYPE html>
<html lang="fr" data-bs-theme="{'default_mode': 'auto', 'disable_switch': False}">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Floris Robart">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>TypeScript (Node.js/Express) - Documentation Floris</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../../css/custom.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Documentation Floris</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">Accueil</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Meta & règles</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../00_meta/all_project/" class="dropdown-item">Tous mes projets</a>
</li>
                                    
<li>
    <a href="../../../00_meta/documentation_rules/" class="dropdown-item">Règles de documentation</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Développement</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Gestion de projets</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../project_management/project_management_tools/" class="dropdown-item">Outils de gestion de projets</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Database</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../database/postgresql/" class="dropdown-item">PostgreSQL</a>
</li>
            
<li>
    <a href="../../database/migrations_and_seeders_by_tanvir/" class="dropdown-item">Migration Laravel</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Back-end</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../java/" class="dropdown-item">Java</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">TypeScript (Node.js/Express)</a>
</li>
            
<li>
    <a href="../laravel/" class="dropdown-item">Laravel</a>
</li>
            
<li>
    <a href="../symfony/" class="dropdown-item">Symfony</a>
</li>
            
<li>
    <a href="../codeigniter/" class="dropdown-item">CodeIgniter</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Front-end</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../frontend/flutter/" class="dropdown-item">Flutter</a>
</li>
            
<li>
    <a href="../../frontend/react/" class="dropdown-item">React</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Déploiement</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../deployment/production_with_docker/" class="dropdown-item">Mise en production d'une application dockerisée</a>
</li>
            
<li>
    <a href="../../deployment/debian_package_creation/" class="dropdown-item">Creation de packets Debian</a>
</li>
            
<li>
    <a href="../../deployment/open_source_licensing_gnu_gpl/" class="dropdown-item">Mise sous licence d'un projet open source</a>
</li>
            
<li>
    <a href="../../deployment/php_web_server_creation/" class="dropdown-item">Création d'un serveur web PHP</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Autres*</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../others/clean_code/" class="dropdown-item">Clean code (Codé proprement)</a>
</li>
            
<li>
    <a href="../../others/web_development_micro_service/" class="dropdown-item">Developpement web en micro-services (Recommandé)</a>
</li>
            
<li>
    <a href="../../others/coding_best_practices_by_chatgpt/" class="dropdown-item">Bonne pratiques de développement by ChatGPT</a>
</li>
            
<li>
    <a href="../../others/web_development_php/" class="dropdown-item">Developpement web en PHP</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Applications</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../02_applications/installation_usage/" class="dropdown-item">Installation d'applications Linux divers</a>
</li>
                                    
<li>
    <a href="../../../02_applications/docker_installation/" class="dropdown-item">Installation de Docker</a>
</li>
                                    
<li>
    <a href="../../../02_applications/git/" class="dropdown-item">Git</a>
</li>
                                    
<li>
    <a href="../../../02_applications/ssh/" class="dropdown-item">SSH</a>
</li>
                                    
<li>
    <a href="../../../02_applications/vscode/" class="dropdown-item">Visual Studio Code</a>
</li>
                                    
<li>
    <a href="../../../02_applications/gnome_shell_connect/" class="dropdown-item">Gnome Shell Connect (GSC)</a>
</li>
                                    
<li>
    <a href="../../../02_applications/ventoy/" class="dropdown-item">Ventoy</a>
</li>
                                    
<li>
    <a href="../../../02_applications/hp_printer_connection/" class="dropdown-item">Connection d'une imprimante HP</a>
</li>
                                    
<li>
    <a href="../../../02_applications/thunderbird_iut_le_havre/" class="dropdown-item">Configuration de Thunderbird pour l'IUT du Havre</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Systèmes</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../03_system/server/server_creation_2026/" class="dropdown-item">Création d'un serveur (2026)</a>
</li>
            
<li>
    <a href="../../../03_system/server/server_creation_2023/" class="dropdown-item">Création d'un serveur (Obsolète - 2023)</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Linux</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../03_system/linux/dual_boot/" class="dropdown-item">Création d'un dual boot</a>
</li>
            
<li>
    <a href="../../../03_system/linux/windows_on_linux/" class="dropdown-item">Utilisation d'outils windows sous Linux</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Windows</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../03_system/windows/windows_security/" class="dropdown-item">Contournement des sécurités Windows</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Android</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../03_system/android/flashing_android_device/" class="dropdown-item">Flashing d'un appareil Android</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Machines virtuelles</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../03_system/virtual_machine/virtual_machines/" class="dropdown-item">Machines virtuels avec VirtualBox</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Autres</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../03_system/others/general_manipulation/" class="dropdown-item">Resolution de problèmes divers sous Linux</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Entrepreneuriat</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../04_entrepreneuriat/company_creation_for_development/" class="dropdown-item">Creation d'une entreprise pour le developpement</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Electronique</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../Aucune documentation pour le moment." class="dropdown-item">Aucune documentation pour le moment</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Autres</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../98_others/creation_page_don_telethon/" class="dropdown-item">Page don Téléthon</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Rechercher
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../java/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Précédent
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../laravel/" class="nav-link">
                                    Suivant <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/FloRobart/Documentations/edit/master/docs/01_development/backend/create_api_typescript.md" class="nav-link">Editer dans Florobart/Documentation
                                    </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table des matières">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#creation-dune-api-avec-typescript" class="nav-link">Création d'une API avec TypeScript</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#table-des-matieres" class="nav-link">Table des matières</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#prerequis" class="nav-link">Prérequis</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#introduction" class="nav-link">Introduction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#creation-du-projet" class="nav-link">Création du projet</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#configuration-du-projet" class="nav-link">Configuration du projet</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#architecture-du-projet" class="nav-link">Architecture du projet</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#licence" class="nav-link">Licence</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="creation-dune-api-avec-typescript">Création d'une API avec TypeScript<a class="headerlink" href="#creation-dune-api-avec-typescript" title="Permanent link">&para;</a></h1>
<h2 id="table-des-matieres">Table des matières<a class="headerlink" href="#table-des-matieres" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#création-dune-api-avec-typescript">Création d'une API avec TypeScript</a><ul>
<li><a href="#table-des-matières">Table des matières</a></li>
<li><a href="#prérequis">Prérequis</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#création-du-projet">Création du projet</a></li>
<li><a href="#configuration-du-projet">Configuration du projet</a></li>
<li><a href="#architecture-du-projet">Architecture du projet</a><ul>
<li><a href="#config">Config</a></li>
<li><a href="#core">Core</a><ul>
<li><a href="#middlewares">Middlewares</a><ul>
<li><a href="#validator-middleware">Validator Middleware</a><ul>
<li><a href="#body-validator-middleware">Body Validator Middleware</a></li>
<li><a href="#params-validator-middleware">Params Validator Middleware</a></li>
<li><a href="#query-validator-middleware">Query Validator Middleware</a></li>
</ul>
</li>
<li><a href="#errors-middleware">Errors Middleware</a></li>
<li><a href="#default-route-middleware">Default Route Middleware</a></li>
<li><a href="#logger-middleware">Logger Middleware</a></li>
</ul>
</li>
<li><a href="#utils">Utils</a><ul>
<li><a href="#loggerts">Logger.ts</a></li>
</ul>
</li>
<li><a href="#models">Models</a><ul>
<li><a href="#apperror-model">AppError model</a></li>
<li><a href="#database-model">Database model</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#modules">Modules</a><ul>
<li><a href="#schema">Schema</a></li>
<li><a href="#types">Types</a></li>
<li><a href="#swagger">Swagger</a></li>
<li><a href="#routes">Routes</a></li>
<li><a href="#controller">Controller</a></li>
<li><a href="#service">Service</a></li>
<li><a href="#repository">Repository</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#licence">Licence</a></li>
</ul>
</li>
</ul>
<h2 id="prerequis">Prérequis<a class="headerlink" href="#prerequis" title="Permanent link">&para;</a></h2>
<p>Avant de commencer, assurez-vous d'avoir installé les éléments suivants sur votre machine :</p>
<ul>
<li><a href="https://nodejs.org/">Node.js</a> (version 14 ou supérieure)</li>
<li><a href="https://www.npmjs.com/">npm</a> (généralement inclus avec Node.js)</li>
<li>Un éditeur de code, tel que <a href="https://code.visualstudio.com/">Visual Studio Code</a></li>
</ul>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Dans ce guide, nous allons créer une API RESTful simple en utilisant TypeScript avec le framework Express.js. Nous allons couvrir les étapes de configuration du projet, la création de routes, la gestion des requêtes et des réponses, ainsi que l'utilisation de TypeScript pour améliorer la qualité du code.</p>
<p>Tous les exemples de se guide sont basés sur mon API open-source : <a href="https://github.com/FloRobart/Econoris_server">Econoris API</a></p>
<h2 id="creation-du-projet">Création du projet<a class="headerlink" href="#creation-du-projet" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>créer le dossier du projet et y accéder :</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>my-api<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>my-api
</code></pre></div>
</li>
<li>
<p>Répondez aux questions pour initialiser le projet</p>
<ul>
<li>À la question <code>entry point</code> répondez "<code>src/server.ts</code>".</li>
</ul>
</li>
<li>Une fois le projet initialisé, vous devriez voir un fichier <code>package.json</code> dans le répertoire du projet. Si c'est le cas, passez à l'étape suivante.</li>
</ul>
<h2 id="configuration-du-projet">Configuration du projet<a class="headerlink" href="#configuration-du-projet" title="Permanent link">&para;</a></h2>
<ul>
<li>Les dépendances sont à installer en fonction des besoins du projet mais certaine dépendances sont quasi obligatoire pour un projet TypeScript avec Express.js afin de fonctionner correctement et d'avoir une bonne structure de code.</li>
<li><strong>Liste des dépendances essentielles :</strong><ul>
<li><a href="https://www.npmjs.com/package/express">express</a> : le framework web pour Node.js.</li>
<li><a href="https://www.npmjs.com/package/zod">zod</a> : pour la validation des données.</li>
<li><a href="https://www.npmjs.com/package/dotenv">dotenv</a> : pour gérer les variables d'environnement.</li>
</ul>
</li>
<li>
<p><strong>Liste des dépendances de développement essentielles :</strong></p>
<ul>
<li><a href="https://www.npmjs.com/package/@types/node">@types/node</a> : les types TypeScript pour Node.js.</li>
<li><a href="https://www.npmjs.com/package/@types/express">@types/express</a> : les types TypeScript pour Express.js.</li>
<li><a href="https://www.npmjs.com/package/@types/jest">@types/jest</a> : les types TypeScript pour Jest.</li>
<li><a href="https://www.npmjs.com/package/typescript">typescript</a> : le compilateur TypeScript.</li>
<li><a href="https://www.npmjs.com/package/ts-node">ts-node</a> : pour exécuter des fichiers TypeScript directement.</li>
<li><a href="https://www.npmjs.com/package/nodemon">nodemon</a> : pour redémarrer automatiquement le serveur lors de modifications.</li>
<li><a href="https://www.npmjs.com/package/jest">jest</a> : le framework de test.</li>
<li><a href="https://www.npmjs.com/package/ts-jest">ts-jest</a> : pour utiliser Jest avec TypeScript.</li>
<li><a href="https://www.npmjs.com/package/swagger-jsdoc">swagger-jsdoc</a> : pour générer la documentation Swagger à partir de commentaires JSDoc.</li>
<li><a href="https://www.npmjs.com/package/swagger-ui-express">swagger-ui-express</a> : pour servir l'interface utilisateur Swagger.</li>
</ul>
</li>
<li>
<p>Pour installer toutes ces dépendances, exécutez les commandes suivantes :</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>express<span class="w"> </span>zod<span class="w"> </span>dotenv
npm<span class="w"> </span>install<span class="w"> </span>--save-dev<span class="w"> </span>@types/node<span class="w"> </span>@types/express<span class="w"> </span>@types/jest<span class="w"> </span>typescript<span class="w"> </span>ts-node<span class="w"> </span>nodemon<span class="w"> </span>jest<span class="w"> </span>ts-jest<span class="w"> </span>swagger-jsdoc<span class="w"> </span>swagger-ui-express
</code></pre></div>
</li>
<li>
<p>Dans votre <code>package.json</code>, ajoutez les scripts suivants pour faciliter le développement et les tests :</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="err">...</span>
<span class="w">    </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tsc&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;node dist/server.js&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nodemon --watch &#39;src/**/*.ts&#39; --exec &#39;ts-node&#39; src/server.ts&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;dev-docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;docker compose -f docker-compose.dev.yml up --build&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;clean&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rm -rf dist&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;clean-docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;docker compose -f docker-compose.dev.yml down --volumes --rmi all&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">...</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Après avoir installé les dépendances, vous pouvez initialiser TypeScript dans votre projet en exécutant la commande suivante :</p>
<div class="highlight"><pre><span></span><code>npx<span class="w"> </span>tsc<span class="w"> </span>--init
</code></pre></div>
</li>
<li>
<p>Ajoutez ses deux lignes dans le fichier <code>tsconfig.json</code></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;include&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;src/**/*.ts&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Ajoutez cette ligne</span>
<span class="w">    </span><span class="nt">&quot;exclude&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;node_modules&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tests&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;jest.config.ts&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Ajoutez cette ligne</span>
<span class="w">    </span><span class="nt">&quot;compilerOptions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">...</span>
<span class="w">        </span><span class="nt">&quot;rootDir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./src&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Décommentez cette ligne</span>
<span class="w">        </span><span class="nt">&quot;outDir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Décommentez cette ligne</span>
<span class="w">        </span><span class="err">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Créer le fichier <code>jest.config.ts</code> à la racine du projet avec le contenu suivant :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;jest&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">preset</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ts-jest&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">testEnvironment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;node&#39;</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// Emplacement des fichiers de tests</span>
<span class="w">    </span><span class="nx">roots</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;&lt;rootDir&gt;/tests/&#39;</span><span class="p">],</span>

<span class="w">    </span><span class="c1">// Motif de nommage des fichiers de tests</span>
<span class="w">    </span><span class="nx">testRegex</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;.*\\.spec\\.ts$&quot;</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// Mappe les alias TypeScript aux chemins réels</span>
<span class="w">    </span><span class="kr">module</span><span class="nx">NameMapper</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;^@/(.*)$&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&lt;rootDir&gt;/src/$1&quot;</span><span class="w"> </span><span class="c1">// (@ --&gt; src/)</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// Fichier exécuté avant les tests (setup global)</span>
<span class="w">    </span><span class="nx">setupFilesAfterEnv</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&lt;rootDir&gt;/tests/setup.ts&quot;</span><span class="p">],</span>

<span class="w">    </span><span class="c1">// Options utiles</span>
<span class="w">    </span><span class="nx">clearMocks</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="c1">// Réinitialise les mocks entre chaque test</span>
<span class="w">    </span><span class="nx">verbose</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="c1">// Affiche des informations détaillées lors de l&#39;exécution des tests</span>

<span class="w">    </span><span class="c1">// Configuration de la couverture de code</span>
<span class="w">    </span><span class="nx">collectCoverage</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// Active la collecte de couverture de code</span>
<span class="w">    </span><span class="nx">coverageDirectory</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;coverage&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Répertoire de sortie pour les rapports de couverture</span>
<span class="w">    </span><span class="nx">coverageReporters</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lcov&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Formats de rapport de couverture</span>
<span class="w">    </span><span class="nx">collectCoverageFrom</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="c1">// Fichiers à inclure dans la couverture</span>
<span class="w">        </span><span class="s2">&quot;&lt;rootDir&gt;/src/**/*.ts&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Inclure tous les fichiers TypeScript dans src</span>
<span class="w">        </span><span class="s2">&quot;!&lt;rootDir&gt;/src/app.ts&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Exclure le fichier d&#39;entrée principal</span>
<span class="w">        </span><span class="s2">&quot;!&lt;rootDir&gt;/src/server.ts&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Exclure les fichiers index</span>
<span class="w">        </span><span class="s2">&quot;!&lt;rootDir&gt;/src/swagger/**&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Exclure les fichiers Swagger</span>
<span class="w">        </span><span class="s2">&quot;!&lt;rootDir&gt;/src/config/**&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Exclure les fichiers de configuration</span>
<span class="w">        </span><span class="s2">&quot;!&lt;rootDir&gt;/src/**/*.types.ts&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Exclure les fichiers de types</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">config</span><span class="p">;</span>
</code></pre></div>
</li>
<li>
<p>Créer le fichier <code>.dockerignore</code> à la racine du projet avec le contenu suivant :</p>
<div class="highlight"><pre><span></span><code>.git
.env
.env.*
</code></pre></div>
</li>
<li>
<p>Créer le fichier <code>Dockerfile</code> à la racine du projet avec le contenu suivant :</p>
<ul>
<li>Plus de détails sur la configuration de sécurité Docker dans le guide de déploiement : <a href="../../deployment/production_with_docker/">Mise en production d'une application dockerisée</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Étape 1 : Build avec TypeScript</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:24-alpine</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Copier le code source</span>
<span class="k">COPY</span><span class="w"> </span>tsconfig.json<span class="w"> </span>./
<span class="k">COPY</span><span class="w"> </span>package*.json<span class="w"> </span>./
<span class="k">COPY</span><span class="w"> </span>./src<span class="w"> </span>./src
<span class="k">COPY</span><span class="w"> </span>./public<span class="w"> </span>./public

<span class="c"># Supprimer les fichiers sensibles s&#39;ils existent</span>
<span class="k">RUN</span><span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>.env*<span class="w"> </span>public/.env*<span class="w"> </span>src/.env*

<span class="c"># Installer les dépendances</span>
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>ci

<span class="c"># Build TypeScript → JavaScript</span>
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>build

<span class="c"># Étape 2 : Image finale</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:24-alpine</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">runner</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Copier uniquement les fichiers nécessaires à l&#39;exécution</span>
<span class="k">COPY</span><span class="w"> </span>package*.json<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>ci<span class="w"> </span>--omit<span class="o">=</span>dev

<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/app/dist<span class="w"> </span>./dist
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/app/public<span class="w"> </span>./public

<span class="c"># Ajout d&#39;un utilisateur non-root avec UID/GID fixes</span>
<span class="k">RUN</span><span class="w"> </span>addgroup<span class="w"> </span>-g<span class="w"> </span><span class="m">1800</span><span class="w"> </span>-S<span class="w"> </span>myapigroup<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>adduser<span class="w"> </span>-u<span class="w"> </span><span class="m">1800</span><span class="w"> </span>-S<span class="w"> </span>myapiuser<span class="w"> </span>-G<span class="w"> </span>myapigroup
<span class="k">USER</span><span class="w"> </span><span class="s">myapiuser</span>

<span class="c"># Par défaut : lance le serveur</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dist/server.js&quot;</span><span class="p">]</span>
</code></pre></div>
</li>
<li>
<p>Créer le fichier <code>docker-compose.yml</code> à la racine du projet avec le contenu suivant :</p>
<ul>
<li>Plus de détails sur la configuration de sécurité Docker dans le guide de déploiement : <a href="../../deployment/production_with_docker/">Mise en production d'une application dockerisée</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">my-api</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-api:latest</span>
<span class="w">        </span><span class="nt">build</span><span class="p">:</span>
<span class="w">            </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">            </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">        </span><span class="nt">env_file</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-api-net</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${APP_PORT:-}:80</span>
<span class="w">        </span><span class="nt">security_opt</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no-new-privileges:true</span>
<span class="w">        </span><span class="nt">cap_drop</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ALL</span>
<span class="w">        </span><span class="nt">cap_add</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BIND_SERVICE</span>
<span class="w">        </span><span class="nt">read_only</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1800:1800&quot;</span>
<span class="w">        </span><span class="nt">tmpfs</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp:exec,nosuid,nodev</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app/dist/swagger/:rw,uid=1800,gid=1800</span>
<span class="w">        </span><span class="nt">healthcheck</span><span class="p">:</span>
<span class="w">            </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;CMD-SHELL&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;wget</span><span class="nv"> </span><span class="s">-q</span><span class="nv"> </span><span class="s">--spider</span><span class="nv"> </span><span class="s">http://econoris-server:80/</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">exit</span><span class="nv"> </span><span class="s">1&quot;</span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">            </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>
<span class="w">            </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">db_data</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">econoris-net</span><span class="p">:</span>
<span class="w">        </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span>
</code></pre></div>
</li>
<li>
<p>Créer le fichier <code>docker-compose.dev.yml</code> à la racine du projet avec le contenu suivant :</p>
<ul>
<li>Plus de détails sur la configuration de sécurité Docker dans le guide de déploiement : <a href="../../deployment/production_with_docker/">Mise en production d'une application dockerisée</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">my-api</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node:24-alpine</span>
<span class="w">        </span><span class="nt">working_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app</span>
<span class="w">        </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./:/app/</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./node_modules:/app/node_modules</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh -c &quot;cd /app &amp;&amp; npm run dev&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-api-net</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${APP_PORT}:80</span>
<span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1800:1800&quot;</span>
<span class="w">        </span><span class="nt">tmpfs</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp:exec,nosuid,nodev</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app/src/swagger/json:rw,uid=1800,gid=1800</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">db_data</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">api-net</span><span class="p">:</span>
<span class="w">        </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span>
</code></pre></div>
</li>
<li>
<p>Créer le fichier <code>.env</code> à la racine du projet avec le contenu suivant :</p>
<div class="highlight"><pre><span></span><code>APP_PORT=3000
NODE_ENV=development
</code></pre></div>
</li>
<li>
<p>Créer le dossier <code>src</code> à la racine du projet. C'est ici que tout le code source TypeScript de l'API sera placé.</p>
</li>
<li>Créer le dossier <code>public</code> à la racine du projet. C'est ici que tous les fichiers publics (comme les icônes, etc.) seront placés.</li>
<li>Créer le dossier <code>tests</code> à la racine du projet. C'est ici que tous les tests unitaires et d'intégration seront placés.</li>
</ul>
<h2 id="architecture-du-projet">Architecture du projet<a class="headerlink" href="#architecture-du-projet" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>À ce stade, votre structure de projet devrait ressembler à ceci :</p>
<div class="highlight"><pre><span></span><code>my-api
├── node_modules # Généré par npm
├── public # Fichiers publics (ex: icones, etc.)
├── src # Code source TypeScript
│   ├── config # Fichiers de configuration
│   ├── core # Logique centrale de l&#39;application
│   ├── modules # Modules fonctionnels de l&#39;application
│   ├── app.ts # Point d&#39;entrée de l&#39;application
│   └── server.ts # Serveur Express
├── tests # Tests unitaires et d&#39;intégration
|   ├── modules # Tests pour les modules
|   └── setup.ts # Configuration des tests
├── .env # Fichier de configuration des variables d&#39;environnement
├── .dockerignore # Fichier Docker ignore
├── Dockerfile # Fichier Docker
├── docker-compose.dev.yml # Fichier Docker Compose pour le développement
├── docker-compose.yml # Fichier Docker Compose pour la production
├── package.json # Fichier de configuration npm
├── package-lock.json # Généré par npm
├── jest.config.ts # Configuration de Jest
├── tsconfig.json # Configuration de TypeScript
└── README.md # Présentation du projet
</code></pre></div>
<ul>
<li>Les dossiers <code>tests</code>, <code>src</code> sont un miroir l'un de l'autre pour faciliter la navigation entre le code source et les tests associés.</li>
<li>Le dossier <code>config</code> contient les fichiers de configuration de l'application, comme la configuration de la base de données, les variables d'environnement, etc.</li>
<li>Le dossier <code>core</code> contient la logique centrale de l'application, comme la gestion des erreurs, la configuration de la base de données, les middlewares globaux, etc.</li>
<li>Le dossier <code>modules</code> contient les différentes fonctionnalités de l'application, chaque fonctionnalité étant organisée dans son propre sous-dossier avec ses routes, contrôleurs, services et modèles.</li>
<li>Le fichier <code>app.ts</code> est le point d'entrée principal de l'application où l'instance Express est créée et configurée.</li>
<li>Le fichier <code>server.ts</code> est responsable du démarrage du serveur Express ainsi que de la connexion à la base de données et les possibles cron jobs.</li>
</ul>
</li>
</ul>
<p>Dans le dossier <code>src</code> nous allons opter pour une architecture modulaire par feature aussi appeler <code>domain-driven design (DDD)</code> qui permet de mieux organiser le code en regroupant les fonctionnalités par domaine métier.</p>
<ul>
<li>Image complète de l'architecture du projet à la fin du guide (Pour l'exemple d'<a href="https://github.com/FloRobart/Econoris_server">Econoris</a>).</li>
</ul>
<div class="highlight"><pre><span></span><code>Econoris_server
├── Database
│   ├── Dockerfile
│   ├── functions
│   │   └── 001-update_updated_at.sql
│   ├── migrations
│   ├── schema
│   │   └── 102-operations.sql
│   ├── seed
│   ├── triggers
│   │   └── 201-update_updated_at.sql
│   └── views
├── public
│   ├── econoris_logo-1024.png
│   ├── econoris_logo-144.png
│   ├── econoris_logo-16.png
│   ├── econoris_logo-192.png
│   ├── econoris_logo-512.png
│   ├── econoris_logo-72.png
│   ├── econoris_logo-96.png
│   ├── favicon.ico
│   └── favicon.png
├── src
│   ├── app.ts
│   ├── config
│   │   └── AppConfig.ts
│   ├── core
│   │   ├── cron
│   │   │   ├── generate_subscription_operations.job.ts
│   │   │   └── validate_operations.job.ts
│   │   ├── email
│   │   │   ├── error.email.ts
│   │   │   ├── mailer.ts
│   │   │   └── mailTemplate.ts
│   │   ├── middlewares
│   │   │   ├── default_route.middleware.ts
│   │   │   ├── error.middleware.ts
│   │   │   ├── helmet_http_headers.middleware.ts
│   │   │   ├── rate_limiter.middleware.ts
│   │   │   └── validators
│   │   │       ├── auth_validator.middleware.ts
│   │   │       ├── body_validator.middleware.ts
│   │   │       └── params_query_validator.middleware.ts
│   │   ├── models
│   │   │   ├── AppError.model.ts
│   │   │   └── Database.model.ts
│   │   └── utils
│   │       └── logger.ts
│   ├── modules
│   │   ├── auth
│   │   │   ├── auth.schema.ts
│   │   │   └── auth.types.ts
│   │   ├── operations
│   │   │   ├── operations.controller.ts
│   │   │   ├── operations.repository.ts
│   │   │   ├── operations.routes.ts
│   │   │   ├── operations.schema.ts
│   │   │   ├── operations.service.ts
│   │   │   ├── operations.swagger.ts
│   │   │   └── operations.types.ts
│   ├── server.ts
│   └── swagger
│       └── swagger.ts
├── tests
│   ├── modules
│   │   ├── auth
│   │   │   └── auth.spec.ts
│   │   └── operations
│   │       └── operations.spec.ts
│   └── setup.ts
├── docker-compose.dev.yml
├── docker-compose.yml
├── Dockerfile
├── tsconfig.json
├── jest.config.ts
├── package.json
├── package-lock.json
└── README.md
</code></pre></div>
<h3 id="config">Config<a class="headerlink" href="#config" title="Permanent link">&para;</a></h3>
<p>Dans le dossier <code>config</code>, il y aura tous se qui concerne la configuration de l'application, au minimum il y aura un object qui contiendra les variables d'environnement inscrites dans le fichier <code>.env</code>.</p>
<ul>
<li>
<p>Créer le fichier <code>AppConfig.ts</code> dans le dossier <code>config</code> avec le contenu suivant :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">dotenv</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;dotenv&#39;</span><span class="p">;</span>

<span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">AppConfigInterface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Application configuration */</span>
<span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">app_name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">app_port</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">host_name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">base_url</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">app_env</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Database */</span>
<span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">db_uri</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* CORS */</span>
<span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">corsOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">origin</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">        </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">        </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">        </span><span class="nx">allowedHeaders</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">AppConfigInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Application configuration */</span>
<span class="w">    </span><span class="nx">app_name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Exemple API&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">app_port</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="nx">host_name</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.HOST_NAME</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">base_url</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.BASE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;http://localhost:80&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">app_env</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.APP_ENV?.toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;dev&#39;</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/* Database */</span>
<span class="w">    </span><span class="nx">db_uri</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_SCHEME</span><span class="si">}</span><span class="sb">://</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_USER</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PASSWORD</span><span class="si">}</span><span class="sb">@</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_HOST</span><span class="si">}</span><span class="sb">:5432/</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_NAME</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/* CORS */</span>
<span class="w">    </span><span class="nx">corsOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">origin</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CORS_ALLOWED_ORIGINS</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">origin</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">origin</span><span class="p">.</span><span class="nx">trim</span><span class="p">()),</span>
<span class="w">        </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">],</span>
<span class="w">        </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">allowedHeaders</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">config</span><span class="p">;</span>
</code></pre></div>
</li>
</ul>
<h3 id="core">Core<a class="headerlink" href="#core" title="Permanent link">&para;</a></h3>
<p>Dans ce dossier <code>core</code>, il y aura tous se qui concerne la logique centrale de l'application, comme la gestion des erreurs, la configuration de la base de données, les middlewares globaux, etc.</p>
<p>Dans se dossier, vous pouvez créer des sous-dossiers pour organiser la logique centrale en fonction de vos besoins.</p>
<ul>
<li><em>Les dossiers recommandés sont</em><ul>
<li>Middlewares</li>
<li>Utils</li>
<li>Models</li>
</ul>
</li>
</ul>
<h4 id="middlewares">Middlewares<a class="headerlink" href="#middlewares" title="Permanent link">&para;</a></h4>
<p>Se dossier contiendra les middlewares globaux de l'application.</p>
<ul>
<li>Créer le dossier <code>middlewares</code> dans le dossier <code>core</code> pour y placer les middlewares globaux de l'application.</li>
<li><em>Les middlewares recommandés sont</em><ul>
<li>Validator Middleware</li>
<li>Errors Middleware</li>
<li>Default Route Middleware</li>
<li>Logger Middleware (Vous pouvez utiliser <a href="https://www.npmjs.com/package/morgan">morgan</a> ou créer votre propre middleware de journalisation simple)</li>
</ul>
</li>
</ul>
<h5 id="validator-middleware">Validator Middleware<a class="headerlink" href="#validator-middleware" title="Permanent link">&para;</a></h5>
<ul>
<li>Créer le dossier <code>validator</code> dans le dossier <code>middlewares</code> pour y placer le middleware de validation des requêtes.</li>
<li><em>Les validateurs recommandés sont</em><ul>
<li>Body Validator Middleware</li>
<li>Params Validator Middleware</li>
<li>Query Validator Middleware</li>
</ul>
</li>
</ul>
<h6 id="body-validator-middleware">Body Validator Middleware<a class="headerlink" href="#body-validator-middleware" title="Permanent link">&para;</a></h6>
<ul>
<li>Créer le fichier <code>body_validator.middleware.ts</code> dans le dossier <code>validator</code> pour y placer le middleware de validation du corps des requêtes.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>body_validator.middleware.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">NextFunction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;express&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ZodType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;zod&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../../models/AppError.model&quot;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">* Middleware générique de validation du corps de la requête avec Zod.</span>
<span class="cm">* @param schema Schéma Zod à utiliser pour la validation.</span>
<span class="cm">* @returns Middleware Express avec req.body.validated contenant les données validées.</span>
<span class="cm">* @throws AppError avec statut 400 si la validation échoue.</span>
<span class="cm">*/</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">bodyValidator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">schema</span><span class="o">:</span><span class="w"> </span><span class="kt">ZodType</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">_res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">validatedData</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">validatedData</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">schema.parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="nx">next</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Invalid request data&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
</li>
</ul>
<h6 id="params-validator-middleware">Params Validator Middleware<a class="headerlink" href="#params-validator-middleware" title="Permanent link">&para;</a></h6>
<ul>
<li>Créer le fichier <code>params_validator.middleware.ts</code> dans le dossier <code>validator</code> pour y placer le middleware de validation des paramètres et des requêtes.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>params_validator.middleware.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">NextFunction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;express&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ZodType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;zod&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../../models/AppError.model&quot;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Middleware générique de validation des paramètres de la requête avec Zod.</span>
<span class="cm"> * @param schema Schéma Zod à utiliser pour la validation.</span>
<span class="cm"> * @returns Middleware Express avec req.body.validated contenant les données validées.</span>
<span class="cm"> * @throws AppError avec statut 400 si la validation échoue.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">paramsValidator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">schema</span><span class="o">:</span><span class="w"> </span><span class="kt">ZodType</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">_res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">validatedData</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">validatedData</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">schema.parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="nx">next</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Invalid request data&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
</li>
</ul>
<h6 id="query-validator-middleware">Query Validator Middleware<a class="headerlink" href="#query-validator-middleware" title="Permanent link">&para;</a></h6>
<ul>
<li>Créer le fichier <code>query_validator.middleware.ts</code> dans le dossier <code>validator</code> pour y placer le middleware de validation des paramètres et des requêtes.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>query_validator.middleware.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">NextFunction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;express&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ZodType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;zod&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../../models/AppError.model&quot;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Middleware générique de validation des queries de la requête avec Zod.</span>
<span class="cm"> * @param schema Schéma Zod à utiliser pour la validation.</span>
<span class="cm"> * @returns Middleware Express avec req.body.validated contenant les données validées.</span>
<span class="cm"> * @throws AppError avec statut 400 si la validation échoue.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">queryValidator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">schema</span><span class="o">:</span><span class="w"> </span><span class="kt">ZodType</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">_res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">validatedData</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">validatedData</span><span class="p">,</span><span class="w"> </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">schema.parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="nx">next</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Invalid request data&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
</li>
</ul>
<h5 id="errors-middleware">Errors Middleware<a class="headerlink" href="#errors-middleware" title="Permanent link">&para;</a></h5>
<ul>
<li>Créer le fichier <code>error.middleware.ts</code> dans le dossier <code>middlewares</code> pour y placer le middleware de gestion des erreurs globales.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>error.middleware.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">NextFunction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;express&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/AppError.model&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Middleware to handle errors.</span>
<span class="cm"> * @param err Error object</span>
<span class="cm"> * @param req Request</span>
<span class="cm"> * @param res Response</span>
<span class="cm"> * @param next NextFunction</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">AppError</span><span class="p">,</span>
<span class="w">    </span><span class="nx">_req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">    </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span>
<span class="w">    </span><span class="nx">_next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span>
<span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">httpStatus</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">500</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;Unknown error occurred&quot;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
</li>
</ul>
<h5 id="default-route-middleware">Default Route Middleware<a class="headerlink" href="#default-route-middleware" title="Permanent link">&para;</a></h5>
<ul>
<li>Créer le fichier <code>default_route.middleware.ts</code> dans le dossier <code>middlewares</code> pour y placer le middleware de route par défaut.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>default_route.middleware.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">NextFunction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;express&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/AppError.model&#39;</span><span class="p">;</span>



<span class="cm">/**</span>
<span class="cm"> * Middleware to handle undefined routes.</span>
<span class="cm"> * @param req Request</span>
<span class="cm"> * @param res Response</span>
<span class="cm"> * @param next NextFunction</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">defaultRouteHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">_req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">_res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;URL not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">404</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h5 id="logger-middleware">Logger Middleware<a class="headerlink" href="#logger-middleware" title="Permanent link">&para;</a></h5>
<ul>
<li>Créer le fichier <code>logger.middleware.ts</code> dans le dossier <code>middlewares</code> pour y placer le middleware de journalisation (logger).</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>logger.middleware.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">NextFunction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;express&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">info</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../utils/logger&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Middleware to log incoming requests.</span>
<span class="cm"> * @param req Request</span>
<span class="cm"> * @param res Response</span>
<span class="cm"> * @param next NextFunction</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">requestLogger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">_res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">info</span><span class="p">(</span><span class="sb">`Incoming request : </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">next</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
</li>
</ul>
<h4 id="utils">Utils<a class="headerlink" href="#utils" title="Permanent link">&para;</a></h4>
<p>Dans ce dossier <code>utils</code>, il y aura toutes les fonctions utilitaires réutilisables dans toute l'application.</p>
<ul>
<li>Créer le dossier <code>utils</code> dans le dossier <code>core</code> pour y placer les fonctions utilitaires réutilisables dans toute l'application.</li>
<li><em>Les utilitaires recommandés sont</em><ul>
<li>Logger.ts</li>
</ul>
</li>
</ul>
<h5 id="loggerts">Logger.ts<a class="headerlink" href="#loggerts" title="Permanent link">&para;</a></h5>
<ul>
<li>Créer le fichier <code>logger.ts</code> dans le dossier <code>utils</code> pour y placer une fonction utilitaire de journalisation simple.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>logger.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">AppConfig</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../config/AppConfig&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sendErrorEmail</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../email/error.email&#39;</span><span class="p">;</span>



<span class="kd">const</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="sb">` [❌] </span><span class="si">${</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_name</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb"> |`</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">warningMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">` [⚠️] </span><span class="si">${</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_name</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb"> |`</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">successMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">` [✅] </span><span class="si">${</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_name</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb"> |`</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">infoMessage</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="sb">` [❕] </span><span class="si">${</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_name</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb"> |`</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">debugMessage</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="sb">` [🐛] </span><span class="si">${</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_name</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb"> |`</span><span class="p">;</span>



<span class="cm">/**</span>
<span class="cm"> * Logger function to log messages based on the environment level.</span>
<span class="cm"> * @description</span>
<span class="cm"> * - If APP_ENV is 0, no logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 1, only error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 2, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 3, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 4, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 5, debug, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * @param args elements to log</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">error</span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_env</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;silent&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Logger function to log messages based on the environment level.</span>
<span class="cm"> * @description</span>
<span class="cm"> * - If APP_ENV is 0, no logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 1, only error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 2, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 3, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 4, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 5, debug, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * @param args elements to log</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">warning</span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_env</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;silent&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">warningMessage</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Logger function to log messages based on the environment level.</span>
<span class="cm"> * @description</span>
<span class="cm"> * - If APP_ENV is 0, no logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 1, only error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 2, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 3, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 4, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 5, debug, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * @param args elements to log</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">success</span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_env</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;silent&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">successMessage</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Logger function to log messages based on the environment level.</span>
<span class="cm"> * @description</span>
<span class="cm"> * - If APP_ENV is 0, no logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 1, only error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 2, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 3, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 4, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 5, debug, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * @param args elements to log</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">info</span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_env</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;silent&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">infoMessage</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Logger function to log messages based on the environment level.</span>
<span class="cm"> * @description</span>
<span class="cm"> * - If APP_ENV is 0, no logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 1, only error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 2, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 3, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 4, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * - If APP_ENV is 5, debug, info, success, warning and error logs will be displayed.</span>
<span class="cm"> * @param args elements to log</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_env</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;silent&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">AppConfig</span><span class="p">.</span><span class="nx">app_env</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;dev&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">debugMessage</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h4 id="models">Models<a class="headerlink" href="#models" title="Permanent link">&para;</a></h4>
<p>Dans ce dossier <code>models</code>, il y aura tous les modèles de données globaux de l'application.</p>
<ul>
<li>Créer le dossier <code>models</code> dans le dossier <code>core</code> pour y placer les modèles de données globaux de l'application.</li>
<li><em>Les modèles recommandés sont</em><ul>
<li>AppError.model.ts</li>
<li>Database.model.ts</li>
</ul>
</li>
</ul>
<h5 id="apperror-model">AppError model<a class="headerlink" href="#apperror-model" title="Permanent link">&para;</a></h5>
<ul>
<li>Créer le fichier <code>AppError.model.ts</code> dans le dossier <code>models</code> pour y placer le modèle de gestion des erreurs personnalisées.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>AppError.model.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Custom Error interface to include HTTP status codes</span>
<span class="cm"> * @param message Error message</span>
<span class="cm"> * @param httpStatus HTTP status code</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">httpStatus</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Internal Server Error&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">httpStatus</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">httpStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">httpStatus</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h5 id="database-model">Database model<a class="headerlink" href="#database-model" title="Permanent link">&para;</a></h5>
<ul>
<li>Créer le fichier <code>Database.model.ts</code> dans le dossier <code>models</code> pour y placer le modèle de configuration de la base de données.</li>
<li>
<p>Copier le contenu suivant dans le fichier <code>Database.model.ts</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">pg</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;pg&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">logger</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../utils/logger&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./AppError.model&#39;</span><span class="p">;</span>



<span class="cm">/*=========================*/</span>
<span class="cm">/* Abstract Database Model */</span>
<span class="cm">/*=========================*/</span>
<span class="cm">/**</span>
<span class="cm"> * Database schema defining the IDatabase interface and Query type.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">IDatabase</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">connect</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">close</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Query type representing a database query with text and optional values.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">Query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)[]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Abstract Database class implementing the IDatabase interface.</span>
<span class="cm"> * This class provides methods to connect to, close, and execute queries on the database.</span>
<span class="cm"> * @abstract</span>
<span class="cm"> * @implements {IDatabase}</span>
<span class="cm"> * @method connect - Connects to the database.</span>
<span class="cm"> * @method close - Closes the database connection.</span>
<span class="cm"> * @method static execute - Executes a query on the database.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ADatabase</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">IDatabase</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">protected</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">client</span><span class="o">:</span><span class="w"> </span><span class="kt">pg.Client</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="k">abstract</span><span class="w"> </span><span class="nx">connect</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">abstract</span><span class="w"> </span><span class="nx">close</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Executes a query on the database</span>
<span class="cm">     * @async</span>
<span class="cm">     * @param query The query to execute</span>
<span class="cm">     * @returns Array of rows returned by the query or an empty array if no rows are returned or an error occurs</span>
<span class="cm">     * @throws AppError if the database is not connected or if the query fails</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">execute</span><span class="o">&lt;</span><span class="nx">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">Query</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s1">&#39;Database not connected&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">query</span><span class="p">.</span><span class="nx">values</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s1">&#39;Database query failed&#39;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Database unknown error&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*================*/</span>
<span class="cm">/* Database Model */</span>
<span class="cm">/*================*/</span>
<span class="cm">/**</span>
<span class="cm"> * Database class to manage PostgreSQL connections and queries.</span>
<span class="cm"> * @extends ADatabase</span>
<span class="cm"> * @method connect - Connects to the database.</span>
<span class="cm"> * @method close - Closes the database connection.</span>
<span class="cm"> * @method static execute - Executes a query on the database.</span>
<span class="cm"> * @example</span>
<span class="cm"> * const db = new Database(&#39;postgresql://user:password@localhost:5432/mydb&#39;);</span>
<span class="cm"> * const rows = await Database.execute({ text: &#39;SELECT * FROM mytable&#39;, values: [] });</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Database</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">ADatabase</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="nx">dburi</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">super</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Connects the server to the database</span>
<span class="cm">     * @async</span>
<span class="cm">     * @param dburi The database URI</span>
<span class="cm">     * @example dburi = &quot;postgresql://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;db_name&gt;&quot;</span>
<span class="cm">     * @returns true if connected successfully, otherwise false</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">connect</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">pg</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dburi</span><span class="p">);</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="w">            </span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;DATABASE ERROR :&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">));</span>
<span class="w">            </span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;DATABASE CONNECTION CLOSED&#39;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s1">&#39;Database connection failed&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Closes the database connection</span>
<span class="cm">     * @async</span>
<span class="cm">     * @returns boolean true if the connection was closed successfully, otherwise false</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">close</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="w">            </span><span class="nx">Database</span><span class="p">.</span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s1">&#39;Database disconnection failed&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h3 id="modules">Modules<a class="headerlink" href="#modules" title="Permanent link">&para;</a></h3>
<p>Dans ce dossier <code>modules</code>, il y aura toutes les fonctionnalités de l'application, chaque fonctionnalité étant organisée dans son propre sous-dossier avec ses routes, contrôleurs, services et modèles.</p>
<p>Voici l'architecture recommandée pour chaque module :</p>
<div class="highlight"><pre><span></span><code>example_module
├── example_module.schema.ts     # Représente les schémas de validation Zod pour le module
├── example_module.types.ts      # Définit les types TypeScript spécifiques au module (à l&#39;aide de z.infer(&lt;ZodSchema&gt;))
├── example_module.swagger.ts    # Définit la documentation Swagger pour le module
├── example_module.routes.ts     # URI routes pour le module avec les middlewares associés (validators, puis appel du controller)
├── example_module.controller.ts # Récupère les données de la requête, appelle le service approprié, puis renvoie la réponse au client
├── example_module.service.ts    # Contient la logique métier principale du module
└── example_module.repository.ts # Gère l&#39;accès aux données et les opérations CRUD pour le module
</code></pre></div>
<p>Vous trouverez ci-dessous une brève description de chaque fichier ainsi que des exemples de contenu pour un module fictif appelé <code>operations</code> et qui gère des opérations financières basiques.</p>
<h4 id="schema">Schema<a class="headerlink" href="#schema" title="Permanent link">&para;</a></h4>
<p>Le fichier <code>operations.schema.ts</code> représente les schémas de validation Zod pour le module <code>operations</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="p">,</span><span class="w"> </span><span class="nx">ZodDate</span><span class="p">,</span><span class="w"> </span><span class="nx">ZodNumber</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;zod&quot;</span><span class="p">;</span>



<span class="cm">/*========*/</span>
<span class="cm">/* SELECT */</span>
<span class="cm">/*========*/</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">z.int</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">    </span><span class="nx">levy_date</span><span class="o">:</span><span class="w"> </span><span class="kt">z.date</span><span class="p">().</span><span class="k">default</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()),</span>
<span class="w">    </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">trim</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span>
<span class="w">    </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">trim</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span>

<span class="w">    </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">trim</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mf">255</span><span class="p">).</span><span class="nx">nullable</span><span class="p">().</span><span class="k">default</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>
<span class="w">    </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">trim</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mf">255</span><span class="p">).</span><span class="nx">nullable</span><span class="p">().</span><span class="k">default</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>
<span class="w">    </span><span class="nx">costs</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="k">default</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
<span class="w">    </span><span class="nx">is_validate</span><span class="o">:</span><span class="w"> </span><span class="kt">z.boolean</span><span class="p">().</span><span class="k">default</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>

<span class="w">    </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="kt">z.int</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">    </span><span class="nx">subscription_id</span><span class="o">:</span><span class="w"> </span><span class="kt">z.int</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">nullable</span><span class="p">().</span><span class="k">default</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>

<span class="w">    </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="kt">z.date</span><span class="p">().</span><span class="k">readonly</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">updated_at</span><span class="o">:</span><span class="w"> </span><span class="kt">z.date</span><span class="p">().</span><span class="k">readonly</span><span class="p">(),</span>
<span class="p">});</span>



<span class="cm">/*========*/</span>
<span class="cm">/* INSERT */</span>
<span class="cm">/*========*/</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">OperationsInsertSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
<span class="w">    </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationsSchema.shape.user_id.optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">levy_date</span><span class="o">:</span><span class="w"> </span><span class="kt">z.preprocess</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="p">,</span><span class="w"> </span><span class="nx">ZodDate</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span>
<span class="w">        </span><span class="nx">z</span><span class="p">.</span><span class="nx">date</span><span class="p">(),</span>
<span class="w">    </span><span class="p">),</span>
<span class="p">}).</span><span class="nx">omit</span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>

<span class="w">    </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">updated_at</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>



<span class="cm">/*========*/</span>
<span class="cm">/* UPDATE */</span>
<span class="cm">/*========*/</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">OperationsIdUpdateSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">z.preprocess</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="p">,</span><span class="w"> </span><span class="nx">ZodNumber</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span>
<span class="w">        </span><span class="nx">z</span><span class="p">.</span><span class="kr">int</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">    </span><span class="p">),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">OperationsUpdateSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OperationsInsertSchema</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationsSchema.shape.id</span><span class="p">,</span>
<span class="p">});</span>



<span class="cm">/*========*/</span>
<span class="cm">/* DELETE */</span>
<span class="cm">/*========*/</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">OperationsIdDeleteSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OperationsIdUpdateSchema</span><span class="p">;</span>
</code></pre></div>
<h4 id="types">Types<a class="headerlink" href="#types" title="Permanent link">&para;</a></h4>
<p>Le fichier <code>operations.types.ts</code> définit les types TypeScript spécifiques au module. Notez l'utilisation de <code>z.infer(&lt;ZodSchema&gt;)</code> pour générer automatiquement les types à partir des schémas Zod définis dans le fichier <code>operations.schema.ts</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;zod&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsInsertSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsUpdateSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsIdUpdateSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsIdDeleteSchema</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./operations.schema&quot;</span><span class="p">;</span>


<span class="cm">/* SELECT */</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cm">/* INSERT */</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">OperationInsert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">OperationsInsertSchema</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cm">/* UPDATE */</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">OperationsIdUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">OperationsIdUpdateSchema</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">OperationUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">OperationsUpdateSchema</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cm">/* DELETE */</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">OperationsIdDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">OperationsIdDeleteSchema</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>
<h4 id="swagger">Swagger<a class="headerlink" href="#swagger" title="Permanent link">&para;</a></h4>
<p>Le fichier <code>operations.swagger.ts</code> définit la documentation Swagger pour le module. Se sont simplement des commentaires qui permettront de générer automatiquement une documentation interactive pour l'API.</p>
<div class="highlight"><pre><span></span><code><span class="cm">/*========*/</span>
<span class="cm">/* SELECT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * @swagger</span>
<span class="cm"> * components:</span>
<span class="cm"> *   schemas:</span>
<span class="cm"> *     Operations:</span>
<span class="cm"> *       type: object</span>
<span class="cm"> *       required:</span>
<span class="cm"> *         - id</span>
<span class="cm"> *         - levy_date</span>
<span class="cm"> *         - label</span>
<span class="cm"> *         - amount</span>
<span class="cm"> *         - category</span>
<span class="cm"> *         - source</span>
<span class="cm"> *         - destination</span>
<span class="cm"> *         - costs</span>
<span class="cm"> *         - is_validate</span>
<span class="cm"> *         - user_id</span>
<span class="cm"> *         - subscription_id</span>
<span class="cm"> *         - created_at</span>
<span class="cm"> *         - updated_at</span>
<span class="cm"> *       properties:</span>
<span class="cm"> *         id:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 1</span>
<span class="cm"> *         levy_date:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;2024-01-01T00:00:00.000Z&quot;</span>
<span class="cm"> *         label:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Sample Operation&quot;</span>
<span class="cm"> *         amount:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 100.00</span>
<span class="cm"> *         category:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Income&quot;</span>
<span class="cm"> *         source:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Job&quot;</span>
<span class="cm"> *         destination:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Bank&quot;</span>
<span class="cm"> *         costs:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 2.50</span>
<span class="cm"> *         is_validate:</span>
<span class="cm"> *           type: boolean</span>
<span class="cm"> *           exemple: true</span>
<span class="cm"> *         user_id:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 1</span>
<span class="cm"> *         subscription_id:</span>
<span class="cm"> *           type: number|null</span>
<span class="cm"> *           exemple: 1</span>
<span class="cm"> *         created_at:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;2024-01-01T00:00:00.000Z&quot;</span>
<span class="cm"> *         updated_at:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;2024-01-01T00:00:00.000Z&quot;</span>
<span class="cm"> */</span>


<span class="cm">/*========*/</span>
<span class="cm">/* INSERT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * @swagger</span>
<span class="cm"> * components:</span>
<span class="cm"> *   schemas:</span>
<span class="cm"> *     OperationsInsert:</span>
<span class="cm"> *       type: object</span>
<span class="cm"> *       required:</span>
<span class="cm"> *         - levy_date</span>
<span class="cm"> *         - label</span>
<span class="cm"> *         - amount</span>
<span class="cm"> *         - category</span>
<span class="cm"> *       properties:</span>
<span class="cm"> *         levy_date:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;2024-01-01T00:00:00.000Z&quot;</span>
<span class="cm"> *         label:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Sample Operation&quot;</span>
<span class="cm"> *         amount:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 100.00</span>
<span class="cm"> *         category:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Income&quot;</span>
<span class="cm"> *         source:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Job&quot;</span>
<span class="cm"> *         destination:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Bank&quot;</span>
<span class="cm"> *         costs:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 2.50</span>
<span class="cm"> *         is_validate:</span>
<span class="cm"> *           type: boolean</span>
<span class="cm"> *           exemple: true</span>
<span class="cm"> */</span>


<span class="cm">/*========*/</span>
<span class="cm">/* UPDATE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * @swagger</span>
<span class="cm"> * components:</span>
<span class="cm"> *   schemas:</span>
<span class="cm"> *     OperationsUpdate:</span>
<span class="cm"> *       type: object</span>
<span class="cm"> *       required:</span>
<span class="cm"> *         - levy_date</span>
<span class="cm"> *         - label</span>
<span class="cm"> *         - amount</span>
<span class="cm"> *         - category</span>
<span class="cm"> *         - source</span>
<span class="cm"> *         - destination</span>
<span class="cm"> *         - costs</span>
<span class="cm"> *         - is_validate</span>
<span class="cm"> *       properties:</span>
<span class="cm"> *         levy_date:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;2024-01-01T00:00:00.000Z&quot;</span>
<span class="cm"> *         label:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Sample Operation&quot;</span>
<span class="cm"> *         amount:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 100.00</span>
<span class="cm"> *         category:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Income&quot;</span>
<span class="cm"> *         source:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Job&quot;</span>
<span class="cm"> *         destination:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           exemple: &quot;Bank&quot;</span>
<span class="cm"> *         costs:</span>
<span class="cm"> *           type: number</span>
<span class="cm"> *           exemple: 2.50</span>
<span class="cm"> *         is_validate:</span>
<span class="cm"> *           type: boolean</span>
<span class="cm"> *           exemple: true</span>
<span class="cm"> */</span>
</code></pre></div>
<h4 id="routes">Routes<a class="headerlink" href="#routes" title="Permanent link">&para;</a></h4>
<p>Le fichier <code>operations.routes.ts</code> définit les URI routes pour le module avec les middlewares associés (validators, puis appel du controller). Dans se fichier ont aura à la fois les routes ainsi que les commentaires Swagger pour documenter chaque endpoint.</p>
<p>Vous noterez l'utilisation des middlewares de validation du corps, des paramètres et des requêtes avant d'appeler les contrôleurs appropriés.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Router</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;express&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OperationsController</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./operations.controller&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bodyValidator</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../../core/middlewares/validators/body_validator.middleware&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OperationsIdDeleteSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsIdUpdateSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsInsertSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsUpdateSchema</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./operations.schema&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">paramsQueryValidator</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../../core/middlewares/validators/params_query_validator.middleware&quot;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Router</span><span class="p">();</span>

<span class="cm">/*========*/</span>
<span class="cm">/* SELECT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * @swagger</span>
<span class="cm"> * /operations:</span>
<span class="cm"> *   get:</span>
<span class="cm"> *     tags:</span>
<span class="cm"> *       - Operations</span>
<span class="cm"> *     summary: Retrieve a list of operations of the authenticated user</span>
<span class="cm"> *     description: Retrieve a list of operations associated with the authenticated user.</span>
<span class="cm"> *     parameters:</span>
<span class="cm"> *       - in: headers</span>
<span class="cm"> *         name: Authorization</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           example: &quot;Bearer &lt;token&gt;&quot;</span>
<span class="cm"> *     responses:</span>
<span class="cm"> *       200:</span>
<span class="cm"> *         description: A list of operations</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               type: array</span>
<span class="cm"> *               items:</span>
<span class="cm"> *                 $ref: &#39;#/components/schemas/Operations&#39;</span>
<span class="cm"> *       204:</span>
<span class="cm"> *         description: No content. No operations found.</span>
<span class="cm"> *       401:</span>
<span class="cm"> *         description: Unauthorized access.</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error401&#39;</span>
<span class="cm"> *       500:</span>
<span class="cm"> *         description: Internal server error. Please create an issue on Github</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error500&#39;</span>
<span class="cm"> */</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsController</span><span class="p">.</span><span class="nx">selectOperations</span><span class="p">);</span>


<span class="cm">/*========*/</span>
<span class="cm">/* INSERT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * @swagger</span>
<span class="cm"> * /operations:</span>
<span class="cm"> *   post:</span>
<span class="cm"> *     tags:</span>
<span class="cm"> *       - Operations</span>
<span class="cm"> *     summary: Create a new operation for the authenticated user</span>
<span class="cm"> *     description: Create a new operation associated with the authenticated user.</span>
<span class="cm"> *     parameters:</span>
<span class="cm"> *       - in: headers</span>
<span class="cm"> *         name: Authorization</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           example: &quot;Bearer &lt;token&gt;&quot;</span>
<span class="cm"> *       - in: body</span>
<span class="cm"> *         name: operation</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         description: Operation object that needs to be added</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           $ref: &#39;#/components/schemas/OperationsInsert&#39;</span>
<span class="cm"> *     responses:</span>
<span class="cm"> *       201:</span>
<span class="cm"> *         description: Created operation</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/Operations&#39;</span>
<span class="cm"> *       400:</span>
<span class="cm"> *         description: Bad request. Please check the input data.</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error400&#39;</span>
<span class="cm"> *       401:</span>
<span class="cm"> *         description: Unauthorized access.</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error401&#39;</span>
<span class="cm"> *       500:</span>
<span class="cm"> *         description: Internal server error. Please create an issue on Github</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error500&#39;</span>
<span class="cm"> */</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">bodyValidator</span><span class="p">(</span><span class="nx">OperationsInsertSchema</span><span class="p">),</span><span class="w"> </span><span class="nx">OperationsController</span><span class="p">.</span><span class="nx">insertOperations</span><span class="p">);</span>


<span class="cm">/*========*/</span>
<span class="cm">/* UPDATE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * @swagger</span>
<span class="cm"> * /operations:</span>
<span class="cm"> *   put:</span>
<span class="cm"> *     tags:</span>
<span class="cm"> *       - Operations</span>
<span class="cm"> *     summary: Update an existing operation for the authenticated user</span>
<span class="cm"> *     description: Update an existing operation associated with the authenticated user.</span>
<span class="cm"> *     parameters:</span>
<span class="cm"> *       - in: headers</span>
<span class="cm"> *         name: Authorization</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           example: &quot;Bearer &lt;token&gt;&quot;</span>
<span class="cm"> *       - in: path</span>
<span class="cm"> *         name: id</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           type: integer</span>
<span class="cm"> *           example: 1</span>
<span class="cm"> *       - in: body</span>
<span class="cm"> *         name: operation</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         description: Operation object that needs to be updated</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           $ref: &#39;#/components/schemas/OperationsUpdate&#39;</span>
<span class="cm"> *     responses:</span>
<span class="cm"> *       200:</span>
<span class="cm"> *         description: Updated operation</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/Operations&#39;</span>
<span class="cm"> *       400:</span>
<span class="cm"> *         description: Bad request. Please check the input data.</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error400&#39;</span>
<span class="cm"> *       401:</span>
<span class="cm"> *         description: Unauthorized access.</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error401&#39;</span>
<span class="cm"> *       500:</span>
<span class="cm"> *         description: Internal server error. Please create an issue on Github</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error500&#39;</span>
<span class="cm"> */</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">paramsQueryValidator</span><span class="p">(</span><span class="nx">OperationsIdUpdateSchema</span><span class="p">),</span><span class="w"> </span><span class="nx">bodyValidator</span><span class="p">(</span><span class="nx">OperationsUpdateSchema</span><span class="p">),</span><span class="w"> </span><span class="nx">OperationsController</span><span class="p">.</span><span class="nx">updateOperations</span><span class="p">);</span>


<span class="cm">/*========*/</span>
<span class="cm">/* DELETE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * @swagger</span>
<span class="cm"> * /operations:</span>
<span class="cm"> *   delete:</span>
<span class="cm"> *     tags:</span>
<span class="cm"> *       - Operations</span>
<span class="cm"> *     summary: Delete an existing operation for the authenticated user</span>
<span class="cm"> *     description: Delete an existing operation associated with the authenticated user.</span>
<span class="cm"> *     parameters:</span>
<span class="cm"> *       - in: headers</span>
<span class="cm"> *         name: Authorization</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           type: string</span>
<span class="cm"> *           example: &quot;Bearer &lt;token&gt;&quot;</span>
<span class="cm"> *       - in: path</span>
<span class="cm"> *         name: id</span>
<span class="cm"> *         required: true</span>
<span class="cm"> *         schema:</span>
<span class="cm"> *           type: integer</span>
<span class="cm"> *           example: 1</span>
<span class="cm"> *     responses:</span>
<span class="cm"> *       200:</span>
<span class="cm"> *         description: Deleted operation</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/Operations&#39;</span>
<span class="cm"> *       400:</span>
<span class="cm"> *         description: Bad request. Please check the input data.</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error400&#39;</span>
<span class="cm"> *       401:</span>
<span class="cm"> *         description: Unauthorized access.</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error401&#39;</span>
<span class="cm"> *       500:</span>
<span class="cm"> *         description: Internal server error. Please create an issue on Github</span>
<span class="cm"> *         content:</span>
<span class="cm"> *           application/json:</span>
<span class="cm"> *             schema:</span>
<span class="cm"> *               $ref: &#39;#/components/schemas/error500&#39;</span>
<span class="cm"> */</span>
<span class="nx">router</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s1">&#39;/:id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">paramsQueryValidator</span><span class="p">(</span><span class="nx">OperationsIdDeleteSchema</span><span class="p">),</span><span class="w"> </span><span class="nx">OperationsController</span><span class="p">.</span><span class="nx">deleteOperations</span><span class="p">);</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div>
<h4 id="controller">Controller<a class="headerlink" href="#controller" title="Permanent link">&para;</a></h4>
<p>Le fichier <code>Operations.controller.ts</code> récupère les données de la requête, appelle le service approprié, puis renvoie la réponse au client</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">NextFunction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;express&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OperationsService</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./operations.service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OperationInsert</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationUpdate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./operations.types&#39;</span><span class="p">;</span>



<span class="cm">/*========*/</span>
<span class="cm">/* SELECT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Get all operations for a user.</span>
<span class="cm"> * @param req.body.user The user object containing the user ID.</span>
<span class="cm"> * @param res The response object.</span>
<span class="cm"> * @param next The next middleware function.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">selectOperations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsService</span><span class="p">.</span><span class="nx">selectOperations</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">operations</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">200</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">204</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>


<span class="cm">/*========*/</span>
<span class="cm">/* INSERT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Insert a new operation for a user.</span>
<span class="cm"> * @param req.body.user The user object containing the user ID.</span>
<span class="cm"> * @param req.body.validatedData.body The validated operation data to insert.</span>
<span class="cm"> * @param res The response object.</span>
<span class="cm"> * @param next The next middleware function.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">insertOperations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operationData</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">validatedData</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="kt">req.body.user.id</span><span class="w"> </span><span class="p">};</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">newOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsService</span><span class="p">.</span><span class="nx">insertOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">newOperation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>


<span class="cm">/*========*/</span>
<span class="cm">/* UPDATE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Update an existing operation for a user.</span>
<span class="cm"> * @param req.body.user The user object containing the user ID.</span>
<span class="cm"> * @param req.body.validatedData.body The validated operation data to update.</span>
<span class="cm"> * @param res The response object.</span>
<span class="cm"> * @param next The next middleware function.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">updateOperations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operationData</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">validatedData</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">req.body.validatedData.params.id</span><span class="p">,</span><span class="w"> </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="kt">req.body.user.id</span><span class="w"> </span><span class="p">};</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsService</span><span class="p">.</span><span class="nx">updateOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>


<span class="cm">/*========*/</span>
<span class="cm">/* DELETE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Delete an operation for a user.</span>
<span class="cm"> * @param req.body.user The user object containing the user ID.</span>
<span class="cm"> * @param req.body.validatedData.params.id The ID of the operation to delete.</span>
<span class="cm"> * @param res The response object.</span>
<span class="cm"> * @param next The next middleware function.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">deleteOperations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">validatedData</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsService</span><span class="p">.</span><span class="nx">deleteOperations</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">operationId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<h4 id="service">Service<a class="headerlink" href="#service" title="Permanent link">&para;</a></h4>
<p>Le fichier <code>operations.service.ts</code> contient la logique métier principale du module. Se fichier peut être plus ou moins complexe en fonction des besoins métier.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Operation</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationInsert</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationUpdate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./operations.types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./operations.repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OperationsInsertSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationsUpdateSchema</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./operations.schema&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ZodError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../core/models/AppError.model&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addDays</span><span class="p">,</span><span class="w"> </span><span class="nx">addWeeks</span><span class="p">,</span><span class="w"> </span><span class="nx">addMonths</span><span class="p">,</span><span class="w"> </span><span class="nx">isAfter</span><span class="p">,</span><span class="w"> </span><span class="nx">endOfMonth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;date-fns&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">updateSubscriptionsLastGeneratedAt</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../subscriptions/subscriptions.service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Subscription</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../subscriptions/subscriptions.types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SubscriptionsSchema</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../subscriptions/subscriptions.schema&#39;</span><span class="p">;</span>



<span class="cm">/*========*/</span>
<span class="cm">/* SELECT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Get all operations for a user.</span>
<span class="cm"> * @param userId The ID of the user.</span>
<span class="cm"> * @returns An array of Operation objects.</span>
<span class="cm"> * @throws AppError if there is an issue retrieving the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">selectOperations</span><span class="p">(</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">selectOperations</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">.</span><span class="nx">array</span><span class="p">().</span><span class="nx">parse</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ZodError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to parse operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get all invalid operations.</span>
<span class="cm"> * @returns An array of Operation objects.</span>
<span class="cm"> * @throws AppError if there is an issue retrieving the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">selectAllOperationsInvalidate</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">selectAllOperationsInvalidate</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">.</span><span class="nx">array</span><span class="p">().</span><span class="nx">parse</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ZodError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to parse operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*========*/</span>
<span class="cm">/* INSERT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Insert a new operation for a user.</span>
<span class="cm"> * @param operationData The operation data to insert.</span>
<span class="cm"> * @returns The newly created Operation object.</span>
<span class="cm"> * @throws AppError if there is an issue inserting the operation.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">insertOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">insertOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ZodError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to parse operation (operation inserted successfully)&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Insert multiple operations for a user in bulk.</span>
<span class="cm"> * @param operations The array of operation data to insert.</span>
<span class="cm"> * @throws AppError if there is an issue inserting the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">insertBulkOperations</span><span class="p">(</span><span class="nx">operationsData</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">[])</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">operationsData</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OperationsInsertSchema</span><span class="p">.</span><span class="nx">array</span><span class="p">().</span><span class="nx">parse</span><span class="p">(</span><span class="nx">operationsData</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">operations</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">operations</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">operations</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">chunks</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">chunk</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">insertBulkOperations</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)));</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">insertBulkOperations</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ZodError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to parse operations bulk&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Generate missing operations for a subscription up to the current date.</span>
<span class="cm"> * @param subscription The subscription object.</span>
<span class="cm"> * @throws AppError if there is an issue generating the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">insertMissingOperations</span><span class="p">(</span><span class="nx">subscription</span><span class="o">:</span><span class="w"> </span><span class="kt">Subscription</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">parsedSubscription</span><span class="o">:</span><span class="w"> </span><span class="kt">Subscription</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">parsedSubscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SubscriptionsSchema</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">subscription</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to parse subscription&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operationsToInsert</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentDate</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">last_generated_at</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">start_date</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">endOfCurrentMonth</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">endOfMonth</span><span class="p">(</span><span class="nx">now</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Ajout de l&#39;opération pour le mois de début si aucune opération n&#39;a encore été générée</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">last_generated_at</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">is_validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentDate</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">now</span><span class="p">;</span>
<span class="w">            </span><span class="nx">operationsToInsert</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">                </span><span class="nx">levy_date</span><span class="o">:</span><span class="w"> </span><span class="kt">currentDate</span><span class="p">,</span>
<span class="w">                </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.label</span><span class="p">,</span>
<span class="w">                </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.amount</span><span class="p">,</span>
<span class="w">                </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.category</span><span class="p">,</span>
<span class="w">                </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.source</span><span class="p">,</span>
<span class="w">                </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.destination</span><span class="p">,</span>
<span class="w">                </span><span class="nx">costs</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.costs</span><span class="p">,</span>
<span class="w">                </span><span class="nx">is_validate</span><span class="p">,</span>
<span class="w">                </span><span class="nx">subscription_id</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.id</span><span class="p">,</span>
<span class="w">                </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.user_id</span><span class="p">,</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">nextDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getNextDate</span><span class="p">(</span><span class="nx">currentDate</span><span class="p">,</span><span class="w"> </span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">interval_unit</span><span class="p">,</span><span class="w"> </span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">interval_value</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">interval_unit</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;months&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">day_of_month</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">nextDate</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">day_of_month</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">end_date</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">isAfter</span><span class="p">(</span><span class="nx">nextDate</span><span class="p">,</span><span class="w"> </span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">end_date</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isAfter</span><span class="p">(</span><span class="nx">nextDate</span><span class="p">,</span><span class="w"> </span><span class="nx">endOfCurrentMonth</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">is_validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextDate</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">now</span><span class="p">;</span>
<span class="w">            </span><span class="nx">operationsToInsert</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">                </span><span class="nx">levy_date</span><span class="o">:</span><span class="w"> </span><span class="kt">nextDate</span><span class="p">,</span>
<span class="w">                </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.label</span><span class="p">,</span>
<span class="w">                </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.amount</span><span class="p">,</span>
<span class="w">                </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.category</span><span class="p">,</span>
<span class="w">                </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.source</span><span class="p">,</span>
<span class="w">                </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.destination</span><span class="p">,</span>
<span class="w">                </span><span class="nx">costs</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.costs</span><span class="p">,</span>
<span class="w">                </span><span class="nx">is_validate</span><span class="p">,</span>
<span class="w">                </span><span class="nx">subscription_id</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.id</span><span class="p">,</span>
<span class="w">                </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="kt">parsedSubscription.user_id</span><span class="p">,</span>
<span class="w">            </span><span class="p">});</span>

<span class="w">            </span><span class="nx">currentDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextDate</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">operationsToInsert</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">insertBulkOperations</span><span class="p">(</span><span class="nx">operationsToInsert</span><span class="p">);</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">updateSubscriptionsLastGeneratedAt</span><span class="p">(</span><span class="nx">parsedSubscription</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">currentDate</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to generate missing operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*========*/</span>
<span class="cm">/* UPDATE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Update an existing operation for a user.</span>
<span class="cm"> * @param operationData The operation data to update.</span>
<span class="cm"> * @returns The updated Operation object.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationUpdate</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">updateOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ZodError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to parse operation (operation updated successfully)&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Update multiple operations validate status in bulk.</span>
<span class="cm"> * @param operations The array of operation data to update.</span>
<span class="cm"> * @param isValidate The validate status to set.</span>
<span class="cm"> * @throws AppError if there is an issue updating the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateBulkOperationsValidate</span><span class="p">(</span><span class="nx">operations</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationUpdate</span><span class="p">[],</span><span class="w"> </span><span class="nx">isValidate</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsedOperations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OperationsUpdateSchema</span><span class="p">.</span><span class="nx">array</span><span class="p">().</span><span class="nx">parse</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">parsedOperations</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationUpdate</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">parsedOperations</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">parsedOperations</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">chunks</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">chunk</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationUpdate</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">updateBulkOperationsValidate</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span><span class="w"> </span><span class="nx">isValidate</span><span class="p">)));</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">updateBulkOperationsValidate</span><span class="p">(</span><span class="nx">parsedOperations</span><span class="p">,</span><span class="w"> </span><span class="nx">isValidate</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to update operations validate status&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*========*/</span>
<span class="cm">/* DELETE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Delete an operation for a user.</span>
<span class="cm"> * @param userId The ID of the user.</span>
<span class="cm"> * @param operationId The ID of the operation to delete.</span>
<span class="cm"> * @returns The deleted Operation object.</span>
<span class="cm"> * @throws AppError if there is an issue deleting the operation.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteOperations</span><span class="p">(</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">operationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">OperationsRepository</span><span class="p">.</span><span class="nx">deleteOperations</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">operationId</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">OperationsSchema</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">operations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ZodError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to parse operation (operation deleted successfully)&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*===========*/</span>
<span class="cm">/* UTILITIES */</span>
<span class="cm">/*===========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Get the next date based on the current date, interval unit, and value.</span>
<span class="cm"> * @param current Current date</span>
<span class="cm"> * @param unit Interval unit (&#39;days&#39;, &#39;weeks&#39;, &#39;months&#39;)</span>
<span class="cm"> * @param value Interval value</span>
<span class="cm"> * @returns The next date</span>
<span class="cm"> * @throws AppError if the interval unit is unsupported</span>
<span class="cm"> */</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getNextDate</span><span class="p">(</span><span class="nx">current</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">,</span><span class="w"> </span><span class="nx">unit</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;days&#39;</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">addDays</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;weeks&#39;</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">addWeeks</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;months&#39;</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">addMonths</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span>
<span class="w">        </span><span class="nx">default</span><span class="o">:</span>
<span class="w">            </span><span class="kt">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="sb">`Unsupported interval unit : </span><span class="si">${</span><span class="nx">unit</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="repository">Repository<a class="headerlink" href="#repository" title="Permanent link">&para;</a></h4>
<p>Le fichier <code>operations.repository.ts</code> gère l'accès aux données et les opérations CRUD pour le module. Si les données sont stockées dans une base de données, ce fichier contiendra les requêtes SQL nécessaires pour interagir avec la base de données, sinon, ce fichier contiendra la logique pour interagir avec le système de stockage de données choisi.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../../core/models/AppError.model&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Database</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../../core/models/Database.model&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Operation</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationInsert</span><span class="p">,</span><span class="w"> </span><span class="nx">OperationUpdate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./operations.types&quot;</span><span class="p">;</span>



<span class="cm">/*========*/</span>
<span class="cm">/* SELECT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Get all operations for a user.</span>
<span class="cm"> * @param userId The ID of the user.</span>
<span class="cm"> * @returns An array of Operation objects.</span>
<span class="cm"> * @throws AppError if there is an issue retrieving the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">selectOperations</span><span class="p">(</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SELECT * FROM operations WHERE user_id = $1;&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">userId</span><span class="p">];</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">execute</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="kt">values</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="cm">/* Automatic conversion of amount and costs fields to Number */</span>
<span class="w">        </span><span class="nx">operations</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">costs</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">operations</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to retrieve operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get all invalid operations.</span>
<span class="cm"> * @returns An array of Operation objects.</span>
<span class="cm"> * @throws AppError if there is an issue retrieving the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">selectAllOperationsInvalidate</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SELECT * FROM operations WHERE is_validate = false AND levy_date &lt;= CURRENT_DATE;&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">execute</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="cm">/* Automatic conversion of amount and costs fields to Number */</span>
<span class="w">        </span><span class="nx">operations</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">costs</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">operations</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to retrieve invalid operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*========*/</span>
<span class="cm">/* INSERT */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Insert a new operation for a user.</span>
<span class="cm"> * @param operationData The operation data to insert.</span>
<span class="cm"> * @returns The newly created Operation object.</span>
<span class="cm"> * @throws AppError if there is an issue inserting the operation.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">insertOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">operationData</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">placeholders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`$</span><span class="si">${</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">operationData</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`INSERT INTO operations (</span><span class="si">${</span><span class="nx">columns</span><span class="si">}</span><span class="sb">) VALUES (</span><span class="si">${</span><span class="nx">placeholders</span><span class="si">}</span><span class="sb">) RETURNING *;`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">execute</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="kt">values</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;No operation inserted&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* Automatic conversion of amount and costs fields to Number */</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">rows</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to insert operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Insert multiple operations for a user in bulk.</span>
<span class="cm"> * @param operations The array of operation data to insert.</span>
<span class="cm"> * @returns void</span>
<span class="cm"> * @throws AppError if there is an issue inserting the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">insertBulkOperations</span><span class="p">(</span><span class="nx">operations</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationInsert</span><span class="p">[])</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">operations</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">operations</span><span class="p">[</span><span class="mf">0</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`INSERT INTO operations (</span><span class="si">${</span><span class="nx">columns</span><span class="si">}</span><span class="sb">) VALUES `</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">valueIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">operation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">operations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">placeholders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`$</span><span class="si">${</span><span class="nx">valueIndex</span><span class="o">++</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">);</span>
<span class="w">            </span><span class="nx">query</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`(</span><span class="si">${</span><span class="nx">placeholders</span><span class="si">}</span><span class="sb">), `</span><span class="p">;</span>
<span class="w">            </span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">operation</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">query</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;;&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to insert bulk operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*========*/</span>
<span class="cm">/* UPDATE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Update an existing operation for a user.</span>
<span class="cm"> * @param operationData The operation data to update.</span>
<span class="cm"> * @returns The updated Operation object.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateOperations</span><span class="p">(</span><span class="nx">operationData</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationUpdate</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Extract id and user_id, prepare fields to update */</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">user_id</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">fieldsToUpdate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">operationData</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">fieldsToUpdate</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">user_id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Missing data to update&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* Build SET clause and values */</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">setClause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb"> = $</span><span class="si">${</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">fieldsToUpdate</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]);</span>

<span class="w">        </span><span class="cm">/* Append id and user_id to values for WHERE clause */</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`UPDATE operations SET </span><span class="si">${</span><span class="nx">setClause</span><span class="si">}</span><span class="sb"> WHERE id = $</span><span class="si">${</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb"> AND user_id = $</span><span class="si">${</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="si">}</span><span class="sb"> RETURNING *;`</span><span class="p">;</span>
<span class="w">        </span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">user_id</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* Execute query */</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">execute</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;No operation updated&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">404</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* Automatic conversion of amount and costs fields to Number */</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">rows</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to update operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Update multiple operations validate status in bulk.</span>
<span class="cm"> * @param operations The array of operation data to update.</span>
<span class="cm"> * @param isValidate The validate status to set.</span>
<span class="cm"> * @throws AppError if there is an issue updating the operations.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateBulkOperationsValidate</span><span class="p">(</span><span class="nx">operations</span><span class="o">:</span><span class="w"> </span><span class="kt">OperationUpdate</span><span class="p">[],</span><span class="w"> </span><span class="nx">isValidate</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;UPDATE operations SET is_validate = $1 WHERE &quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">isValidate</span><span class="p">];</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">conditions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">operations</span><span class="p">.</span><span class="nx">map</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">((</span><span class="nx">operation</span><span class="p">,</span><span class="w"> </span><span class="nx">_index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">operation</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">operation</span><span class="p">.</span><span class="nx">user_id</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="sb">`(id = $</span><span class="si">${</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb"> AND user_id = $</span><span class="si">${</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="p">;</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; OR &quot;</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">finalQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">conditions</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;;&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">finalQuery</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to update operations validate status&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*========*/</span>
<span class="cm">/* DELETE */</span>
<span class="cm">/*========*/</span>
<span class="cm">/**</span>
<span class="cm"> * Delete an operation for a user.</span>
<span class="cm"> * @param userId The ID of the user.</span>
<span class="cm"> * @param operationId The ID of the operation to delete.</span>
<span class="cm"> * @returns The deleted Operation object.</span>
<span class="cm"> * @throws AppError if there is an issue deleting the operation.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteOperations</span><span class="p">(</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">operationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`DELETE FROM operations WHERE id = $1 AND user_id = $2 RETURNING *;`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">operationId</span><span class="p">,</span><span class="w"> </span><span class="nx">userId</span><span class="p">];</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Database</span><span class="p">.</span><span class="nx">execute</span><span class="o">&lt;</span><span class="nx">Operation</span><span class="o">&gt;</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;No operation deleted&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">404</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* Automatic conversion of amount and costs fields to Number */</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">rows</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">costs</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span><span class="s2">&quot;Failed to delete operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="licence">Licence<a class="headerlink" href="#licence" title="Permanent link">&para;</a></h2>
<p>Copyright (C) 2024 Floris Robart</p>
<p>Authors: Floris Robart</p>
<p>This program is free software; you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation; either version 2.1 of the License, or
(at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Lesser General Public License for more details.</p>
<p>You should have received a copy of the GNU Lesser General Public License
along with this program; if not, write to the Free Software Foundation,
Inc., 51 Franklin Street, Fifth Floor, Boston MA 02110-1301, USA.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation générée avec <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Rechercher</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p>Ici vous pouvez chercher dans les documents. Entrez votre recherche ci-dessous.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Rechercher..." id="mkdocs-search-query" title="Tapez vos mots clés ici">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="Aucun résultat trouvé"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Raccourcis Clavier</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Touches</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Ouvrir l'aide</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Page suivante</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Page précédente</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Rechercher</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
